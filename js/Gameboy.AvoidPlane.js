Ctrl.cache("Gameboy.AvoidPlane",function(){var p=K.object("Gameboy.AvoidPlane"),n,g,j=Gameboy.GameKeys,l,q,o,i,m;l={LEFT:1,CENTER:2,RIGHT:3,getRandomPos:function(){var a=Math.random();if(a<1/3)return this.LEFT;if(a<2/3)return this.CENTER;return this.RIGHT}};i={defaultLife:4,nextLifeWiat4:200,passOneScore:100,passOneScore1:10,upLevelScore:500,gameIndex:0,barrierPro:0.4};o={delCount:0,genedPlane:false,sideSpace:1,tempMap:[],maps:{empty:[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,
0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]],list:[[[0,0,8,0,0,8,0,0,0,0,0],[0,8,8,8,8,8,8,0,0,0,0],[0,0,8,0,0,8,0,0,0,0,0],[0,8,8,8,8,8,8,0,0,0,0]],[[0,8,8,8,8,8,8,0,0,0,0],[0,0,8,0,0,8,0,0,0,0,0],[0,8,8,8,8,8,8,0,0,0,0],[0,0,8,0,0,8,0,0,0,0,0]],[[0,0,8,0,8,8,8,0,0,0,0],[0,8,8,8,0,8,0,0,0,0,0],[0,0,8,0,8,8,8,0,0,0,0],[0,8,8,8,0,8,0,0,0,0,0]],[[0,8,8,8,0,8,0,0,0,0,0],[0,0,8,0,8,8,8,0,0,0,0],[0,8,8,8,0,8,0,0,0,0,0],[0,0,8,0,8,8,8,0,0,0,0]],[[0,0,8,0,0,0,0,0,8,0,0],[0,8,8,8,0,0,0,8,8,8,0],[0,0,8,0,0,0,0,0,8,0,
0],[0,8,8,8,0,0,0,8,8,8,0]],[[0,0,8,0,0,0,0,8,8,8,0],[0,8,8,8,0,0,0,0,8,0,0],[0,0,8,0,0,0,0,8,8,8,0],[0,8,8,8,0,0,0,0,8,0,0]],[[0,8,8,8,0,0,0,0,8,0,0],[0,0,8,0,0,0,0,8,8,8,0],[0,8,8,8,0,0,0,0,8,0,0],[0,0,8,0,0,0,0,8,8,8,0]],[[0,8,8,8,0,0,0,8,8,8,0],[0,0,8,0,0,0,0,0,8,0,0],[0,8,8,8,0,0,0,8,8,8,0],[0,0,8,0,0,0,0,0,8,0,0]],[[0,0,0,0,0,8,0,0,8,0,0],[0,0,0,0,8,8,8,8,8,8,0],[0,0,0,0,0,8,0,0,8,0,0],[0,0,0,0,8,8,8,8,8,8,0]],[[0,0,0,0,8,8,8,0,8,0,0],[0,0,0,0,0,8,0,8,8,8,0],[0,0,0,0,8,8,8,0,8,0,0],[0,0,0,0,
0,8,0,8,8,8,0]],[[0,0,0,0,8,8,8,8,8,8,0],[0,0,0,0,0,8,0,0,8,0,0],[0,0,0,0,8,8,8,8,8,8,0],[0,0,0,0,0,8,0,0,8,0,0]],[[0,0,0,0,0,8,0,8,8,8,0],[0,0,0,0,8,8,8,0,8,0,0],[0,0,0,0,0,8,0,8,8,8,0],[0,0,0,0,8,8,8,0,8,0,0]]]},getPlaneLineMap:function(){var a,b=this,d=1+Math.floor(Math.random()*g.cfg.maxColor);if(i.gameIndex==1){a=K.clone(b.maps.empty);if(b.genedPlane){if(b.nextPlanePath)b.lastPlanePath=b.nextPlanePath;b.nextPlanePath=b.minPlanePath+Math.floor(Math.random()*b.maxPlanePath)}b.genedPlane=!b.genedPlane}else if(b.genedPlane){a=
K.clone(b.maps.empty);b.genedPlane=false}else{a=K.clone(b.maps.list[Math.floor(Math.random()*b.maps.list.length)]);b.genedPlane=true}for(var e=a.length-1;e>=0;e--){for(var c=1,f=a[e].length-1,h,k;c<f;c++)if(i.gameIndex==1)if(b.genedPlane){h=Math.min(b.lastPlanePath,b.nextPlanePath);k=Math.max(b.lastPlanePath,b.nextPlanePath)+3;if(c<h||c>k)if(Math.random()<=i.barrierPro)a[e][c]=d}else{if(c<b.lastPlanePath||c>b.lastPlanePath+3)if(Math.random()<=i.barrierPro)a[e][c]=d}else if(a[e][c]!=0)a[e][c]=d;if(b.sideSpace%
3!=0){a[e][0]=g.cfg.defaultColor;a[e][f]=g.cfg.defaultColor;b.sideSpace++}else b.sideSpace=1}return a},init:function(a){var b=this;b.tempMap=[];b.delCount=0;b.genedPlane=i.gameIndex?true:false;b.sideSpace=1;for(var d=0,e=a.length,c;d<e;d++){c=a[d].length;b.tempMap[d]=[];for(var f=0;f<c;f++)if(d%3!=0&&(f==0||f==c-1))this.tempMap[d][f]=g.cfg.defaultColor;else b.tempMap[d][f]=0}b.mainMap=a;b.maxPlanePath=b.mainMap[0].length-3-1;b.minPlanePath=1;b.lastPlanePath=b.minPlanePath+Math.floor(Math.random()*
b.maxPlanePath);b.tempMap=this.getPlaneLineMap().concat(this.tempMap);K.mix(this,K.Evt)},updateMap:function(){for(var a=this,b=a.mainMap,d=a.tempMap,e=d.length-1,c=d.length-b.length,f=b.length-1;e>=c;e--,f--)for(var h=0,k=d[e].length;h<k;h++)b[f][h]=d[e][h];if(a.$fire){a.fireEvt("displane");delete a.$fire}else if(i.gameIndex==1){e=1;f=d.length-1;for(c=d[f].length-1;e<c;e++)if(d[f][e]!=0){a.$fire=true;break}}else{e=1;f=d.length-1;c=d[f].length-1;for(b=false;e<c;e++)if(d[f][e]!=0){for(h=1;h<c;h++)if(d[f-
1][h]!=0){b=true;break}if(!b)a.$fire=true;break}}d.pop();a.delCount++;if(a.delCount>=4){a.tempMap=a.getPlaneLineMap().concat(a.tempMap);a.delCount=0}}};q=K.clazz({planeShape:[[0,1,0],[1,1,1],[0,1,0],[1,1,1]],x:0,maxShapeHeight:0,pos:l.getRandomPos(),maxShapeWidth:0,ctor:function(){var a=0,b=0,d=this;b=d.planeShape;for(var e=0,c=b.length;e<c;e++)a=Math.max(a,b[e].length);b=c;d.maxShapeHeight=b;d.maxShapeWidth=a}});m={START:"sounds/plane/start.mp3",MOVE:"sounds/plane/move.mp3",BOMB:"sounds/plane/bomb.mp3",
OVER:"sounds/plane/over.mp3"};n={activePlaneId:"_avoid_plane",life:i.defaultLife,init:function(){var a=this;a.mainMap=g.mapMgr.mainMap;a.drawLife();if(!a.$plane)a.$plane=new q;a.drawActivePlane();a.movePlaneTo(a.$plane.pos);o.init(a.mainMap);a.drawStage();o.ondisplane=function(){if(!a.$score)a.$score=0;a.$score+=i.gameIndex?i.passOneScore1:i.passOneScore;g.core.updateScoreAndSpeed(a.$score,i.upLevelScore)}},clear:function(){g.mapMgr.clearStage();g.mapMgr.updateStage();this.delActivePlane()},delActivePlane:function(){K.nodeDel(this.activePlaneId)},
getLifeMap:function(){for(var a=[],b=0;b<i.defaultLife+1-this.life;b++)a[b]=[];for(b=i.defaultLife+1-this.life;b<i.defaultLife+1;b++)a[b]=[0,1];return a},drawActivePlane:function(){var a=this,b=a.activePlaneId;if(!K(b)){var d=K("div",{id:b},{position:"absolute"});document.body.appendChild(d);g.mapMgr.drawMap({id:b,size:[a.$plane.maxShapeWidth,a.$plane.maxShapeHeight]});a=a.$plane.planeShape;var e;d=g.cfg;for(var c=0,f=a.length;c<f;c++)for(var h=0,k=a[c].length;h<k;h++)if(a[c][h]==1&&(e=K(K.strFormat(d.cellIdFormat,
b,c,h))))e.className=g.cfg.specialCellClass}},drawLife:function(){g.mapMgr.resetNext();g.mapMgr.drawNext(this.getLifeMap(),g.cfg.defaultColor)},drawStage:function(){var a=this;o.updateMap();g.mapMgr.updateStage();a.isCollide()},drawPlaneBurst:function(){for(var a=this,b=a.$plane.maxShapeWidth,d=a.$plane.maxShapeHeight,e,c=0;c<d;c++)for(var f=0;f<b;f++)if(e=K(K.strFormat(g.cfg.cellIdFormat,a.activePlaneId,c,f)))e.className=g.cfg.specialUsedCellClass},movePlaneTo:function(a){var b=0,d=0,e=this,c=e.$plane,
f=g.mapMgr,h=0;d=f.stageBound.y+f.stageBound.height-f.cellSize.height*c.maxShapeHeight;if(a==l.LEFT){b=f.stageBound.x+f.cellSize.width;h=1}else if(a==l.CENTER){b=f.stageBound.x+f.cellSize.width*(c.maxShapeWidth+1);h=1+c.maxShapeWidth}else if(a==l.RIGHT){b=f.stageBound.x+f.stageBound.width-f.cellSize.width*(c.maxShapeWidth+1);h=1+2*c.maxShapeWidth}c.pos=a;c.x=h;g.soundPlayer.play2(m.MOVE);K.nodeStyle(e.activePlaneId,{left:b+"px",top:d+"px"});e.isCollide()},canMoveTo:function(a){return a==j.LEFT?this.$plane.x>
1:this.$plane.x<this.mainMap[0].length-1-3},movePlaneTo1:function(a){var b=this,d=0;d=g.mapMgr;if(b.canMoveTo(a)){g.soundPlayer.play2(m.MOVE);if(a==j.LEFT)b.$plane.x--;else b.$plane.x++;d=d.stageBound.x+d.cellSize.width*b.$plane.x;K.nodeStyle(b.activePlaneId,{left:d+"px"});b.isCollide()}},isCollide:function(){if(!this.$tempOver){var a,b,d,e,c=this,f=false;e=c.mainMap.length-1;d=e-c.$plane.maxShapeHeight+1;a=i.gameIndex==1?c.$plane.x:c.$plane.pos==l.LEFT?1:c.$plane.pos==l.CENTER?1+c.$plane.maxShapeWidth:
1+2*c.$plane.maxShapeWidth;b=a+c.$plane.maxShapeWidth-1;d=d;for(var h=0;d<=e;d++,h++){for(var k=a,r=0;k<=b;k++,r++)if(i.gameIndex==1){if(c.mainMap[d][k]!=0&&c.$plane.planeShape[h][r]!=0){f=true;break}}else if(c.mainMap[d][k]!=0){f=true;break}if(f)break}if(f){c.$tempOver=true;c.pause();c.drawPlaneBurst();g.soundPlayer.play1(m.BOMB);K.timer(function(){c.clear();if(c.life){c.life--;c.init();c.start()}else c.over();delete c.$isFastDown;delete c.$tempOver},i.nextLifeWiat4)}}},pause:function(){K.clsTimer(this.$timer);
delete this.$timer},resetSpeed:function(a){var b=this;b.pause();b.$timer=K.timer(b.drawStage,a/2,1,b)},start:function(){this.resetSpeed(g.cfg.speed)},startFastDown:function(){this.resetSpeed(g.cfg.fastSpeed)},stopFastDown:function(){this.resetSpeed(g.cfg.speed)},over:function(){this.pause();g.core.showGameOver();g.soundPlayer.play1(m.OVER);this.life=i.defaultLife;delete this.$score},receiveKey:function(a){var b=this,d=b.$plane;if(!b.$tempOver)if(a==j.LEFT)if(i.gameIndex==1)b.movePlaneTo1(a);else d.pos>
1&&b.movePlaneTo(d.pos-1);else if(a==j.RIGHT)if(i.gameIndex==1)b.movePlaneTo1(a);else d.pos<3&&b.movePlaneTo(d.pos+1);else if(a==j.START||a==j.GON){g.soundPlayer.play1(m.START);b.start()}else if(a==j.PAUSE)b.pause();else if(a==j.DOWN||a==j.UP){if(!b.$isFastDown){b.drawStage();b.$isFastDown=true;b.startFastDown()}}else if(a==j.DOWNRELEASE||a==j.UPRELEASE)if(b.$isFastDown){delete b.$isFastDown;b.stopFastDown()}}};K.mix(p,Gameboy.AbstractGame);K.mix(p,{name:"AvoidPlane",innerGameCount:2,init:function(a){g=
a;n.init()},setInnerGameIndex:function(a){i.gameIndex=a},receiveKey:function(a){n.receiveKey(a)},updateSpeed:function(a){n.resetSpeed(a)}})});
